<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Мини D&D</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<!-- ================== LOGIN ================== -->
<div id="login-container">
  <h2>Вход в игру</h2>
  <input type="text" id="username" placeholder="Введите имя">
  <select id="role">
    <option value="GM">GM</option>
    <option value="Player">Игрок</option>
    <option value="Spectator">Наблюдатель</option>
  </select>
  <button id="joinBtn">Войти</button>
  <p id="loginError" style="color:red;"></p>
</div>


<!-- ================== ROOMS LOBBY ================== -->
<div id="rooms-container" style="display:none;">
  <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
    <h2 style="margin:0;">Комнаты</h2>
    <button id="createRoomBtn">Создать комнату</button>
  </div>

  <div id="rooms-list" style="margin-top:12px;"></div>
  <p id="roomsError" style="color:#ff6b6b; margin-top:10px;"></p>
</div>

<!-- ===== Create room modal ===== -->
<div id="createRoomModal" class="modal-overlay hidden">
  <div class="modal" style="max-width:520px;">
    <div class="modal-header">
      <div>
        <div class="modal-title">Создать комнату</div>
        <div class="modal-subtitle">Пароль необязателен</div>
      </div>
      <button id="createRoomClose" class="modal-close">✕</button>
    </div>

    <div class="modal-body">
      <div class="sheet-card" style="display:flex; flex-direction:column; gap:10px;">
        <input id="roomNameInput" type="text" placeholder="Название комнаты">
        <input id="roomPasswordInput" type="text" placeholder="Пароль (необязательно)">
        <input id="roomScenarioInput" type="text" placeholder="Название сценария D&D (необязательно)">

        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:6px;">
          <button id="createRoomCancel">Отмена</button>
          <button id="createRoomSubmit">Создать</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ================== MAIN GAME ================== -->
<div id="main-container" style="display:none;">

  <!-- Верхняя строка -->
  <div id="status-bar">
    <span>Вы: <strong id="myName">-</strong></span> |
    <span>Роль: <strong id="myRole">-</strong></span> |
    <span>Комната: <strong id="myRoom">-</strong></span> |
    <span>Сценарий: <strong id="myScenario">-</strong></span>
  </div>

  <!-- Контент: 2 колонки -->
  <div id="content-row">

<!-- Левая панель -->
<div id="action-log-container">

  <!-- ЖУРНАЛ -->
  <div id="action-log">
    <h3>Журнал действий:</h3>
    <ul id="log-list"></ul>
  </div>

  <!-- СТРОКА ПОД ЖУРНАЛОМ -->
  <div id="action-bottom-row">

    <!-- УПРАВЛЕНИЕ ИГРОКАМИ -->
    <div id="player-management">
      <h3>Управление игроками:</h3>

      <div id="player-controls">
        <input type="text" id="player-name" placeholder="Имя игрока">
        <input type="color" id="player-color" value="#ff0000">

<label>Размер:
  <select id="player-size">
    <option value="1">1x1</option>
    <option value="2">2x2</option>
    <option value="3">3x3</option>
    <option value="4">4x4</option>
    <option value="5">5x5</option>
  </select>
</label>

        <div class="player-type">
          <label class="type-item">
            <input type="checkbox" id="is-base">
            Основа
          </label>
        </div>

        <button id="add-player">Добавить игрока</button>
      </div>
    </div>

    <!-- ПОЛЬЗОВАТЕЛИ И ПЕРСОНАЖИ -->
    <div id="player-list-container">
      <h3>Пользователи и персонажи:</h3>
      <ul id="player-list"></ul>
    </div>

  </div>
</div>

    <!-- Игровая колонка -->
    <div id="game-container">

      <div id="board-row">

        <!-- Левая часть (ширина = ширина поля). Всё, что "над полем", центрируется относительно поля -->
        <div id="board-col">

          <div id="board-topbar">

            <!-- Очередность хода (видно в фазе инициативы и боя) -->
            <div id="turn-order-box" class="turn-order-box" style="display:none;">
              <div class="turn-order-head">
                <div class="turn-order-title">Очередность хода</div>
                <div class="turn-order-round">Круг - <span id="turn-order-round">1</span></div>
              </div>
              <ul id="turn-order-list" class="turn-order-list"></ul>
            </div>

            <!-- Текущий игрок — по центру поля, над рамками размеров -->
            <div id="current-turn">
              Текущий игрок: <span id="current-player">-</span>
              <button id="next-turn" class="next-turn-btn" type="button" title="Конец хода (по инициативе)">
                Конец хода
              </button>
            </div>

            <div id="board-settings">
            <div id="board-settings-viewport" class="board-settings-box">
              <label>Ширина поля:
                <input type="number" id="board-width" value="10" min="5" max="80" title="Сколько клеток видно в рамке (персональная настройка)">
              </label>
              <label>Высота поля:
                <input type="number" id="board-height" value="10" min="5" max="80" title="Сколько клеток видно в рамке (персональная настройка)">
              </label>
              <button id="create-board" type="button" title="Применить размер рамки (только для вас)">Применить вид</button>
            </div>

            <!-- Только для GM: реальный размер карты (количество клеток внутри поля) -->
            <div id="board-settings-gm" class="board-settings-box" style="margin-top:8px;">
              <label>Ширина поля (ГМ):
                <input type="number" id="board-width-gm" value="10" min="5" max="150" title="Реальная ширина карты в клетках (5–150)">
              </label>
              <label>Высота поля (ГМ):
                <input type="number" id="board-height-gm" value="10" min="5" max="150" title="Реальная высота карты в клетках (5–150)">
              </label>
              <button id="create-board-gm" type="button" title="Изменить реальный размер карты (видно всем)">Применить карту</button>
            </div>
            </div>

          </div>

          <div id="board-wrapper">
            <div id="game-board">
              <!-- Подложка карты (ГМ загружает картинку/.gif). Растягивается на весь размер поля. -->
              <div id="board-bg" aria-hidden="true"></div>
            </div>
          </div>

          <div id="initiative-warning" style="display:none; color: orange; font-weight: bold;">
            Бросьте инициативу за своих персонажей!
          </div>

        </div>

        <!-- Правая колонка (только для GM, управляется в client.js) -->
        <div id="right-panel">

          <div id="world-phases" class="side-box">
            <h3>Фазы мира</h3>
            <button id="start-exploration">Фаза исследования</button>
            <button id="start-initiative">Фаза инициативы</button>
            <button id="start-combat">Фаза бой</button>
          </div>

          <div id="env-editor" class="side-box">
            <h3>Редактирования окружения</h3>
            <button id="edit-environment">Редактирование окружения: ВЫКЛ</button>
            <button id="add-wall" disabled>Добавить стену</button>
            <button id="remove-wall" disabled>Удалить стену</button>
            <div class="env-range-row">
              <div class="env-range-title">
                <span>Прозрачность стен</span>
                <span id="wall-opacity-val">0%</span>
              </div>
              <input id="wall-opacity" type="range" min="0" max="100" value="0" />
            </div>


            <div class="env-bg-controls">
              <div class="env-bg-title">Подложка карты</div>
              <div class="env-bg-url-row">
                <input id="board-bg-url" type="text" placeholder="Ссылка на изображение или GIF (https://...)" />
                <button id="board-bg-url-apply" type="button">Загрузить</button>
              </div>

              <div class="env-range-row">
                <div class="env-range-title">
                  <span>Прозрачность клеток</span>
                  <span id="grid-opacity-val">0%</span>
                </div>
                <input id="grid-opacity" type="range" min="0" max="100" value="0" />
              </div>

              <input id="board-bg-file" type="file" accept="image/*,.gif" />
              <button id="board-bg-clear" type="button">Убрать подложку</button>
            </div>

            <div class="campaign-maps-controls">
              <div class="campaign-maps-title">Карты кампании</div>
              <div class="campaign-maps-row">
                <div class="campaign-active-map" title="Текущая выбранная карта">
                  Активная: <span id="campaign-active-map-name">—</span>
                </div>
                <button id="campaign-params" type="button">Параметры</button>
              </div>
              <!-- Старые элементы оставлены для совместимости, но скрыты (управление в окне «Параметры») -->
              <select id="campaign-maps-select" title="Выбор карты" style="display:none"></select>
              <button id="create-campaign-map" type="button" style="display:none">Создать карту</button>
            </div>

            <button id="save-campaign" type="button">Сохранить кампанию</button>
            <button id="load-campaign" type="button">Загрузить кампанию</button>

            <button id="open-monsters" type="button" title="Открыть библиотеку монстров SRD 5.1 (CC BY 4.0)">Монстры SRD</button>

            <button id="clear-board">Очистить поле</button>
            <button id="reset-game">Сбросить игру полностью</button>
          </div>

        </div>
    </div>
  </div>
</div>

<!-- Dice Visualizer (bottom-left) -->
<div id="dice-viz" class="dice-viz">
  <div class="dice-viz-title">Бросок</div>

  <!-- Инициатива: отдельная кнопка внутри панели, НЕ выпирает -->
  <button id="roll-initiative" class="dice-viz-btn dice-viz-btn--initiative" type="button">
    Инициатива
  </button>

  <!-- Строка броска: кубик + количество + Бросить -->
  <div class="dice-viz-controls">
    <select id="dice" class="dice-viz-select" title="Выбор кубика">
      <option value="2">d2</option>
      <option value="4">d4</option>
      <option value="6">d6</option>
      <option value="8">d8</option>
      <option value="10">d10</option>
      <option value="12">d12</option>
      <option value="20" selected>d20</option>
      <option value="100">d100</option>
    </select>

    <input id="dice-count"
           class="dice-viz-count"
           type="number"
           min="1"
           max="20"
           value="1"
           title="Количество кубиков">

    <button id="roll" class="dice-viz-btn dice-viz-btn--roll" type="button">Бросить</button>
  </div>

  <canvas id="dice-canvas" width="220" height="140"></canvas>

  <div id="dice-rolls" class="dice-viz-rolls" aria-label="Результаты броска"></div>

  <div class="dice-viz-meta">
    <span id="dice-viz-kind">d20 × 1</span>
    <span id="dice-viz-value">—</span>
  </div>
</div>

</div><!-- /#main-container -->

<!-- ================== MODAL: SHEET INFO ================== -->
<div id="sheet-modal" class="modal-overlay hidden" aria-hidden="true">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-title" id="sheet-title">Информация о персонаже</div>
        <div class="modal-subtitle" id="sheet-subtitle"></div>
      </div>
      <button id="sheet-close" class="modal-close" title="Закрыть">✕</button>
    </div>

    <div class="modal-body">
      <div id="sheet-actions" class="sheet-actions"></div>
      <div id="sheet-content" class="sheet-content"></div>
    </div>
  </div>
</div>

<!-- Supabase (realtime + DB). Configure in the block below. -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // === SUPABASE CONFIG (fill these) ===
  // Project URL: Supabase Dashboard -> Project Settings -> API -> Project URL
  window.SUPABASE_URL = "https://iwtxisgxikbddzqwpzsk.supabase.co";
  // anon public key: Supabase Dashboard -> Project Settings -> API -> anon public
  window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml3dHhpc2d4aWtiZGR6cXdwenNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1ODM5ODEsImV4cCI6MjA4NjE1OTk4MX0.gLCl7G-J8WvEVMcfQgzDRe-NCfrzCMLOFZ-51Ph5QRM";
  // Optional: Edge Function URL for CORS proxy (dnd.su spell pages)
  // Example: https://<project-ref>.functions.supabase.co/fetch
  window.SUPABASE_FETCH_FN = "fetch";
</script>

  <script src="controlbox.js"></script>
  <script src="monsters-library.js"></script>
  <script src="client.js"></script>
  <script src="info-dnd-player.js" defer></script>

</body>
</html>
